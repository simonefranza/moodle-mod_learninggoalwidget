define(["jquery","mod_learninggoalwidget/controller","core/templates","core/modal_factory","core/modal_events","core/str"],(c,d,i,a,g,s)=>{var m={GOAL_MODAL_VIEW:"mod_learninggoalwidget/editor/goalmodalview",TOPIC_MODAL_VIEW:"mod_learninggoalwidget/editor/topicmodalview",TOPIC:"mod_learninggoalwidget/editor/topic",GOAL:"mod_learninggoalwidget/editor/goal",NOTOPICS:"mod_learninggoalwidget/editor/notopics"},p={ITEM_TITLE_FIELD:'[data-action="itemtitle"]',ITEM_SHORTNAME_FIELD:'[data-action="itemshortname"]',ITEM_URL_FIELD:'[data-action="itemurl"]'},h=null,u=null,v=null,w=null,r=null,o=null;const l=e=>{0===e.children.length?c("#notopics").removeClass("d-none"):e.children.forEach(e=>{var n={topicname:e[2],topicid:e[1]};s.get_string("settings:showgoals","mod_learninggoalwidget").then(o=>(i.render(m.TOPIC,n).then(e=>{c("#notopics").addClass("d-none"),c("#goalsfortopic").removeClass("d-none"),c("#goalsfortopicstatusmessage").html(o),c("#topics-list").append(e);var t=n.topicid;return c("#topic-item-"+t).click(y),c("#"+t+"-action-edit").click(k),c("#"+t+"-action-delete").click(T),c("#"+t+"-action-moveup").click(E),c("#"+t+"-action-movedown").click(O),e}).catch(()=>{}),0)).catch(()=>{})})},_=(o,e)=>{0<e.length?(c("#goalsfortopic").addClass("d-none"),e.forEach(e=>{var t={topicid:o,goalid:e[1],learninggoaltitle:e[2]};i.render(m.GOAL,t).then(e=>{c("#learninggoals-list").append(e);e=t.goalid;c("#"+o+"-goal-"+e+"-action-edit").click(n),c("#"+o+"-goal-"+e+"-action-delete").click(S),c("#"+o+"-goal-"+e+"-action-moveup").click(I),c("#"+o+"-goal-"+e+"-action-movedown").click(b)}).catch(()=>{})})):s.get_string("settings:nogoals","mod_learninggoalwidget").then(e=>(c("#goalsfortopic").removeClass("d-none"),c("#goalsfortopicstatusmessage").html(e),0)).catch(()=>{})},y=e=>{e.preventDefault();var t=c(e.currentTarget).data("topicid");w.children.forEach(e=>{e[1]===t&&(c("#learninggoals-list").children().remove(),_(t,e[5]))}),r=t,null!==o&&o.css("background-color","white"),(o=c(e.currentTarget)).css("background-color","gainsboro")},f=()=>{s.get_strings([{key:"settings:topic",component:"mod_learninggoalwidget"},{key:"settings:description",component:"mod_learninggoalwidget"},{key:"settings:addtopic",component:"mod_learninggoalwidget"},{key:"settings:link",component:"mod_learninggoalwidget"}]).then(e=>{var t={title:e[0],shortname:e[1],weburl:e[3]};return L(t,e[2],m.TOPIC_MODAL_VIEW,"Speichern",(t,e,o,n)=>{d.insertTopic({course:h,coursemodule:u,instance:v,topicname:e,topicshortname:o,topicurl:n}).then(e=>{t.hide(),c("#topics-list").children().remove(),w=JSON.parse(e),l(w)}).catch(()=>{})}),0}).catch(()=>{})},k=e=>{e.preventDefault();var o,n,i,a=c(e.currentTarget).data("topicid");w.children.forEach(function(e){e[1]===a&&(o=e[2],n=e[3],i=e[4])});s.get_strings([{key:"settings:topic",component:"mod_learninggoalwidget"},{key:"settings:description",component:"mod_learninggoalwidget"},{key:"settings:edittopic",component:"mod_learninggoalwidget"},{key:"settings:link",component:"mod_learninggoalwidget"},{key:"settings:save",component:"mod_learninggoalwidget"}]).then(e=>{var t={title:e[0],shortname:e[1],weburl:e[3],topictitle:o,topicshortname:n,topicurl:i};return L(t,e[2],m.TOPIC_MODAL_VIEW,e[4],(t,e,o,n)=>{d.updateTopic({course:h,coursemodule:u,instance:v,topicid:a,topicname:e,topicshortname:o,topicurl:n}).then(e=>{t.hide(),c("#topics-list").children().remove(),w=JSON.parse(e),l(w)}).catch(()=>{})}),0}).catch(()=>{})},T=e=>{e.preventDefault();const o=c(e.currentTarget).data("topicid");s.get_strings([{key:"settings:deletetopic",component:"mod_learninggoalwidget"},{key:"settings:deletetopicmsg",component:"mod_learninggoalwidget"},{key:"settings:delete",component:"mod_learninggoalwidget"}]).then(e=>(D(e[0],e[1],e[2],t=>{d.deleteTopic({course:h,coursemodule:u,instance:v,topicid:o}).then(e=>{t.hide(),c("#topics-list").children().remove(),c("#learninggoals-list").children().remove(),w=JSON.parse(e),l(w)}).catch(()=>{})}),0)).catch(()=>{})},E=e=>{e.preventDefault();e=c(e.currentTarget).data("topicid");d.moveUpTopic({course:h,coursemodule:u,instance:v,topicid:e}).then(e=>{c("#topics-list").children().remove(),w=JSON.parse(e),l(w)}).catch(()=>{})},O=e=>{e.preventDefault();e=c(e.currentTarget).data("topicid");d.moveDownTopic({course:h,coursemodule:u,instance:v,topicid:e}).then(e=>{c("#topics-list").children().remove(),w=JSON.parse(e),l(w)}).catch(()=>{})},A=()=>{var o;null!==r&&(o="",w.children.forEach(e=>{e[1]===r&&(o=e[2])}),s.get_strings([{key:"settings:topic",component:"mod_learninggoalwidget"},{key:"settings:goal",component:"mod_learninggoalwidget"},{key:"settings:description",component:"mod_learninggoalwidget"},{key:"settings:link",component:"mod_learninggoalwidget"},{key:"settings:addgoal",component:"mod_learninggoalwidget"},{key:"settings:save",component:"mod_learninggoalwidget"}]).then(e=>{var t={topiclabel:e[0],title:e[1],shortname:e[2],weburl:e[3],topictitle:o};return L(t,e[4],m.GOAL_MODAL_VIEW,e[5],(t,e,o,n)=>{d.insertGoal({course:h,coursemodule:u,instance:v,topicid:r,goalname:e,goalshortname:o,goalurl:n}).then(e=>{t.hide(),w=JSON.parse(e),c("#learninggoals-list").children().remove(),w.children.forEach(e=>{e[1]===r&&_(r,e[5])})}).catch(()=>{})}),0}).catch(()=>{}))},n=e=>{e.preventDefault();var o,n,i,a,r=c(e.currentTarget).data("topicid"),l=c(e.currentTarget).data("goalid");w.children.forEach(e=>{e[1]===r&&(o=e[2],e[5].forEach(e=>{e[1]===l&&(n=e[2],i=e[3],a=e[4])}))});s.get_strings([{key:"settings:topic",component:"mod_learninggoalwidget"},{key:"settings:goal",component:"mod_learninggoalwidget"},{key:"settings:description",component:"mod_learninggoalwidget"},{key:"settings:link",component:"mod_learninggoalwidget"},{key:"settings:editgoal",component:"mod_learninggoalwidget"},{key:"settings:save",component:"mod_learninggoalwidget"}]).then(e=>{var t={topiclabel:e[0],topictitle:o,title:e[1],shortname:e[2],weburl:e[3],goaltitle:n,goalshortname:i,goalurl:a};return L(t,e[4],m.GOAL_MODAL_VIEW,e[5],(t,e,o,n)=>{d.updateGoal({course:h,coursemodule:u,instance:v,topicid:r,goalid:l,goalname:e,goalshortname:o,goalurl:n}).then(e=>{t.hide(),w=JSON.parse(e),c("#learninggoals-list").children().remove(),w.children.forEach(e=>{e[1]===r&&_(r,e[5])})}).catch(()=>{})}),0}).catch(()=>{})},S=e=>{e.preventDefault();const o=c(e.currentTarget).data("topicid"),n=c(e.currentTarget).data("goalid");s.get_strings([{key:"settings:deletegoal",component:"mod_learninggoalwidget"},{key:"settings:deletegoalmsg",component:"mod_learninggoalwidget"},{key:"settings:delete",component:"mod_learninggoalwidget"}]).then(e=>(D(e[0],e[1],e[2],t=>{d.deleteGoal({course:h,coursemodule:u,instance:v,topicid:o,goalid:n}).then(e=>{t.hide(),w=JSON.parse(e),c("#learninggoals-list").children().remove(),w.children.forEach(e=>{e[1]===o&&_(o,e[5])})}).catch(()=>{})}),0)).catch(()=>{})},I=e=>{e.preventDefault();const t=c(e.currentTarget).data("topicid");e=c(e.currentTarget).data("goalid");d.moveUpGoal({course:h,coursemodule:u,instance:v,topicid:t,goalid:e}).then(e=>{w=JSON.parse(e),c("#learninggoals-list").children().remove(),w.children.forEach(e=>{e[1]===t&&_(t,e[5])})}).catch(()=>{})},b=e=>{e.preventDefault();const t=c(e.currentTarget).data("topicid");e=c(e.currentTarget).data("goalid");d.moveDownGoal({course:h,coursemodule:u,instance:v,topicid:t,goalid:e}).then(e=>{w=JSON.parse(e),c("#learninggoals-list").children().remove(),w.children.forEach(e=>{e[1]===t&&_(t,e[5])})}).catch(()=>{})},L=(e,t,o,n,c)=>{s.get_strings([{key:"validation:missingtitle",component:"mod_learninggoalwidget"},{key:"validation:invalidlink",component:"mod_learninggoalwidget"}]).then(l=>(a.create({type:a.types.SAVE_CANCEL,title:t,body:i.render(o,e)}).done(r=>(r.setSaveButtonText(n),r.getRoot().on(g.save,e=>{var t=r.getRoot().find(p.ITEM_TITLE_FIELD),o=r.getRoot().find(p.ITEM_SHORTNAME_FIELD),n=r.getRoot().find(p.ITEM_URL_FIELD);let i=!1,a=!1;void 0!==t[0].value&&""!==t[0].value&&(i=!0),P(n[0].value)&&(a=!0),i&&a?c(r,t[0].value,o[0].value,n[0].value):(e.preventDefault(),e.stopPropagation(),!1===i&&(r.getRoot().find('[data-action="titlefeedback"]').text(l[0]),r.getRoot().find('[data-action="titlefeedback"]').css("display","inline")),!1===a&&(r.getRoot().find('[data-action="urlfeedback"]').text(l[1]),r.getRoot().find('[data-action="urlfeedback"]').css("display","inline")))}),r.show(),r.getRoot().on(g.hidden,()=>{r.destroy()}),r)),0)).catch(()=>{})},D=(e,t,o,n)=>{a.create({type:a.types.SAVE_CANCEL,title:e,body:t}).then(e=>(e.setSaveButtonText(o),e.getRoot().on(g.save,async()=>{await n(e)}),e.getRoot().on(g.hidden,()=>{e.destroy()}),e.show(),e)).catch(()=>{})},P=e=>{if(null===e||""==e)return!0;let t=!1;var o=new RegExp(/https?:\/\/(www\.)?[-a-zA-Z0-9@:%._+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()@:%_+.~#?&//=]*)?/gi);return t=e.match(o)?!0:t},j=async t=>{var e="name"in(e=t)&&null!==e.name&&void 0!==e.name?"children"in e&&null!==e.children&&void 0!==e.children?Array.isArray(e.children)?0===e.children.length?{error:!0,code:"validation:jsontop4"}:{error:!1}:{error:!0,code:"validation:jsontop3"}:{error:!0,code:"validation:jsontop2"}:{error:!0,code:"validation:jsontop1"};if(e.error)return e.msg=await s.get_string(e.code,"mod_learninggoalwidget"),e;let o="<pre>";for(let e=0;e<t.children.length;e++){var n=t.children[e],i=(e=>{if(!("name"in e&&null!==e.name&&void 0!==e.name))return{error:!0,code:"validation:jsontopic1",codeParam:void 0};if("string"!=typeof e.name)return{error:!0,code:"validation:jsontopic2",codeParam:e.name};if("link"in e){if("string"!=typeof e.link)return{error:!0,code:"validation:jsontopic3",codeParam:e.name};if(!P(e.link))return{error:!0,code:"validation:jsontopic4",codeParam:e.name}}else{if("keyword"in e&&"string"!=typeof e.keyword)return{error:!0,code:"validation:jsontopic5",codeParam:e.name};if(!("children"in e&&null!==e.children&&void 0!==e.children))return{error:!1};if(!Array.isArray(e.children))return{error:!0,code:"validation:jsontopic6",codeParam:e.name}}return{error:!1}})(n);if(i.error)return i.msg=await s.get_string(i.code,"mod_learninggoalwidget",i.codeParam),i;o+=n.name.replaceAll("&","&amp").replaceAll("<","&lt").replaceAll(">","&gt")+`
`;for(let e=0;e<n.children.length;e++){var a=n.children[e],r=((e,t)=>{if(!("name"in t&&null!==t.name&&void 0!==t.name))return{error:!0,code:"validation:jsongoal1",codeParam:e};if("string"!=typeof t.name)return{error:!0,code:"validation:jsongoal2",codeParam:e};if("link"in t){if("string"!=typeof t.link)return{error:!0,code:"validation:jsongoal3",codeParam:t.name};if(!P(t.link))return{error:!0,code:"validation:jsongoal4",codeParam:t.name}}else if("keyword"in t&&"string"!=typeof t.keyword)return{error:!0,code:"validation:jsongoal5",codeParam:t.name};return{error:!1}})(n.name,a);if(r.error)return r.msg=await s.get_string(r.code,"mod_learninggoalwidget",r.codeParam),r;r=e==n.children.length-1;o+=` |- ${a.name.replaceAll("&","&amp").replaceAll("<","&lt").replaceAll(">","&gt")}
`+(r?"\n\n":"\n")}}return{error:!1,preview:o+="</pre>"}},N=()=>{var e=document.querySelector("#json-file");if(0!==e.files.length){const a=new FileReader;a.readAsText(e.files[0],"UTF-8"),a.onload=async e=>{if(null!==e.target)try{const i=JSON.parse(a.result);var t=await j(i),o=[{key:"validation:invalid",component:"mod_learninggoalwidget"},{key:"validation:invalidfile",component:"mod_learninggoalwidget"},{key:"validation:close",component:"mod_learninggoalwidget"},{key:"settings:newtaxonomyheader",component:"mod_learninggoalwidget"},{key:"settings:newtaxonomymsg",component:"mod_learninggoalwidget"},{key:"settings:replace",component:"mod_learninggoalwidget"}],n=await s.get_strings(o);t.error?D(n[0],n[1]+":<br/>"+t.msg,n[2],e=>{e.hide()}):D(n[3],n[4]+"\n"+t.preview,n[5],async e=>{var t;await new Promise((t,o)=>{d.deleteTaxonomy({course:h,coursemodule:u,instance:v}).then(e=>t(e)).catch(e=>o(e))});c("#topics-list").children().remove(),c("#learninggoals-list").children().remove(),t=await new Promise((t,o)=>{d.addTaxonomy({course:h,coursemodule:u,instance:v,taxonomy:JSON.stringify(i)}).then(e=>t(e)).catch(e=>o(e))}),w=JSON.parse(t),l(w),e.hide()})}catch(e){}}}},R=async()=>{var e=await new Promise((t,o)=>{d.getTaxonomy({course:h,coursemodule:u,instance:v}).then(e=>t(JSON.parse(e))).catch(e=>o(e))});let n={name:e.name,children:[]};e.children.forEach(e=>{let t=[];var o={};3<=e.length&&(o.name=e[2],4<=e.length)&&(o.keyword=e[3],5<=e.length)&&(o.link=e[4]),6<=e.length&&e[5].forEach(e=>{t.push({}),3<=e.length&&(t[t.length-1].name=e[2],4<=e.length)&&(t[t.length-1].keyword=e[3],5<=e.length)&&(t[t.length-1].link=e[4])}),o.children=t,n.children.push(o)});var e="taxonomy.json",t=new Blob([JSON.stringify(n,null,2)],{type:"text/csv"}),o=(window.navigator.msSaveOrOpenBlob&&window.navigator.msSaveBlob(t,e),document.createElement("a"));o.setAttribute("href",window.URL.createObjectURL(t)),o.setAttribute("download",e),o.style.display="none",document.body.appendChild(o),o.click(),document.body.removeChild(o)};return{init:(e,t,o,n)=>{h=e,u=t,v=o,w=JSON.parse(n),l(w),c("#newtopic").click(f),c("#newgoal").click(A),c("#json-upload").click(N),c("#json-download").click(R)}}});
//# sourceMappingURL=form_settings.min.js.map