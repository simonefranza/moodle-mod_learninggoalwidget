define(["jquery","mod_learninggoalwidget/controller","core/templates","core/modal_factory","core/modal_events"],(l,c,t,o,d)=>{var s={GOAL_MODAL_VIEW:"mod_learninggoalwidget/editor/goalmodalview",TOPIC_MODAL_VIEW:"mod_learninggoalwidget/editor/topicmodalview",TOPIC:"mod_learninggoalwidget/editor/topic",GOAL:"mod_learninggoalwidget/editor/goal",NOTOPICS:"mod_learninggoalwidget/editor/notopics"},h={ITEM_TITLE_FIELD:'[data-action="itemtitle"]',ITEM_SHORTNAME_FIELD:'[data-action="itemshortname"]',ITEM_URL_FIELD:'[data-action="itemurl"]'},g=null,m=null,u=null,p=null,a=null,r=null;const f=e=>{0===e.children.length?l("#notopics").removeClass("d-none"):e.children.forEach(e=>{var r={topicname:e[2],topicid:e[1]};t.render(s.TOPIC,r).then(e=>{l("#notopics").addClass("d-none"),l("#goalsfortopic").removeClass("d-none"),l("#goalsfortopicstatusmessage").html("Klicken Sie auf einen Themenbereich, um die Lernziele hier anzuzeigen"),l("#topics-list").append(e);var n=r.topicid;return l("#topic-item-"+n).click(i),l("#"+n+"-action-edit").click(b),l("#"+n+"-action-delete").click(E),l("#"+n+"-action-moveup").click(w),l("#"+n+"-action-movedown").click(k),e}).catch(()=>{})})},v=(r,e)=>{0<e.length?(l("#goalsfortopic").addClass("d-none"),e.forEach(e=>{var n={topicid:r,goalid:e[1],learninggoaltitle:e[2]};t.render(s.GOAL,n).then(e=>{l("#learninggoals-list").append(e);e=n.goalid;l("#"+r+"-goal-"+e+"-action-edit").click(L),l("#"+r+"-goal-"+e+"-action-delete").click(S),l("#"+r+"-goal-"+e+"-action-moveup").click(A),l("#"+r+"-goal-"+e+"-action-movedown").click(O)}).catch(()=>{})})):(l("#goalsfortopic").removeClass("d-none"),l("#goalsfortopicstatusmessage").html("Für den gewählten Themenbereich sind keine Lernziele vorhanden"))},i=e=>{e.preventDefault();var n=l(e.currentTarget).data("topicid");p.children.forEach(e=>{e[1]===n&&(l("#learninggoals-list").children().remove(),v(n,e[5]))}),a=n,null!==r&&r.css("background-color","white"),(r=l(e.currentTarget)).css("background-color","gainsboro")},T=()=>{_({title:"Themenbereich",shortname:"Kurzbezeichnung",weburl:"Web Adresse"},"Neuen Themenbereich hinzufügen",s.TOPIC_MODAL_VIEW,"Speichern",(n,e,r,i)=>{c.insertTopic({course:g,coursemodule:m,instance:u,topicname:e,topicshortname:r,topicurl:i}).then(e=>{n.hide(),l("#topics-list").children().remove(),p=JSON.parse(e),f(p)}).catch(()=>{})})},b=e=>{e.preventDefault();var n,r,i,t=l(e.currentTarget).data("topicid"),e=(p.children.forEach(function(e){e[1]===t&&(n=e[2],r=e[3],i=e[4])}),{title:"Themenbereich",shortname:"Kurzbezeichnung",weburl:"Web Adresse",topictitle:n,topicshortname:r,topicurl:i});_(e,"Themenbereich editieren",s.TOPIC_MODAL_VIEW,"Speichern",(n,e,r,i)=>{c.updateTopic({course:g,coursemodule:m,instance:u,topicid:t,topicname:e,topicshortname:r,topicurl:i}).then(e=>{n.hide(),l("#topics-list").children().remove(),p=JSON.parse(e),f(p)}).catch(()=>{})})},E=e=>{e.preventDefault();const r=l(e.currentTarget).data("topicid");z("Themenbereich löschen","Möchten Sie den Themenbereich wirklich löschen?","Löschen",n=>{c.deleteTopic({course:g,coursemodule:m,instance:u,topicid:r}).then(e=>{n.hide(),l("#topics-list").children().remove(),l("#learninggoals-list").children().remove(),p=JSON.parse(e),f(p)}).catch(()=>{})})},w=e=>{e.preventDefault();e=l(e.currentTarget).data("topicid");c.moveUpTopic({course:g,coursemodule:m,instance:u,topicid:e}).then(e=>{l("#topics-list").children().remove(),p=JSON.parse(e),f(p)}).catch(()=>{})},k=e=>{e.preventDefault();e=l(e.currentTarget).data("topicid");c.moveDownTopic({course:g,coursemodule:m,instance:u,topicid:e}).then(e=>{l("#topics-list").children().remove(),p=JSON.parse(e),f(p)}).catch(()=>{})},y=()=>{var n,e;null!==a&&(n="",p.children.forEach(e=>{e[1]===a&&(n=e[2])}),e={topiclabel:"Themenbereich",topictitle:n,title:"Lernziel",shortname:"Kurzbezeichnung",weburl:"Web Adresse"},_(e,"Neues Lernziel hinzufügen",s.GOAL_MODAL_VIEW,"Speichern",(n,e,r,i)=>{c.insertGoal({course:g,coursemodule:m,instance:u,topicid:a,goalname:e,goalshortname:r,goalurl:i}).then(e=>{n.hide(),p=JSON.parse(e),l("#learninggoals-list").children().remove(),p.children.forEach(e=>{e[1]===a&&v(a,e[5])})}).catch(()=>{})}))},L=e=>{e.preventDefault();var n,r,i,t,o=l(e.currentTarget).data("topicid"),a=l(e.currentTarget).data("goalid"),e=(p.children.forEach(e=>{e[1]===o&&(n=e[2],e[5].forEach(e=>{e[1]===a&&(r=e[2],i=e[3],t=e[4])}))}),{topiclabel:"Themenbereich",topictitle:n,title:"Lernziel",shortname:"Kurzbezeichnung",weburl:"Web Adresse",goaltitle:r,goalshortname:i,goalurl:t});_(e,"Lernziel editieren",s.GOAL_MODAL_VIEW,"Speichern",(n,e,r,i)=>{c.updateGoal({course:g,coursemodule:m,instance:u,topicid:o,goalid:a,goalname:e,goalshortname:r,goalurl:i}).then(e=>{n.hide(),p=JSON.parse(e),l("#learninggoals-list").children().remove(),p.children.forEach(e=>{e[1]===o&&v(o,e[5])})}).catch(()=>{})})},S=e=>{e.preventDefault();const r=l(e.currentTarget).data("topicid"),i=l(e.currentTarget).data("goalid");z("Lernziel löschen","Möchten Sie das Lernziel wirklich löschen?","Löschen",n=>{c.deleteGoal({course:g,coursemodule:m,instance:u,topicid:r,goalid:i}).then(e=>{n.hide(),p=JSON.parse(e),l("#learninggoals-list").children().remove(),p.children.forEach(e=>{e[1]===r&&v(r,e[5])})}).catch(()=>{})})},A=e=>{e.preventDefault();const n=l(e.currentTarget).data("topicid");e=l(e.currentTarget).data("goalid");c.moveUpGoal({course:g,coursemodule:m,instance:u,topicid:n,goalid:e}).then(e=>{p=JSON.parse(e),l("#learninggoals-list").children().remove(),p.children.forEach(e=>{e[1]===n&&v(n,e[5])})}).catch(()=>{})},O=e=>{e.preventDefault();const n=l(e.currentTarget).data("topicid");e=l(e.currentTarget).data("goalid");c.moveDownGoal({course:g,coursemodule:m,instance:u,topicid:n,goalid:e}).then(e=>{p=JSON.parse(e),l("#learninggoals-list").children().remove(),p.children.forEach(e=>{e[1]===n&&v(n,e[5])})}).catch(()=>{})},_=(e,n,r,i,l)=>{o.create({type:o.types.SAVE_CANCEL,title:n,body:t.render(r,e)}).done(a=>(a.setSaveButtonText(i),a.getRoot().on(d.save,e=>{var n=a.getRoot().find(h.ITEM_TITLE_FIELD),r=a.getRoot().find(h.ITEM_SHORTNAME_FIELD),i=a.getRoot().find(h.ITEM_URL_FIELD);let t=!1,o=!1;void 0!==n[0].value&&""!==n[0].value&&(t=!0),D(i[0].value)&&(o=!0),t&&o?l(a,n[0].value,r[0].value,i[0].value):(e.preventDefault(),e.stopPropagation(),!1===t&&(a.getRoot().find('[data-action="titlefeedback"]').text("Der Titel ist verpflichtend einzugeben"),a.getRoot().find('[data-action="titlefeedback"]').css("display","inline")),!1===o&&(a.getRoot().find('[data-action="urlfeedback"]').text("Der Wert für die URL ist ungültig"),a.getRoot().find('[data-action="urlfeedback"]').css("display","inline")))}),a.show(),a.getRoot().on(d.hidden,()=>{a.destroy()}),a))},z=(e,n,r,i)=>{o.create({type:o.types.SAVE_CANCEL,title:e,body:n}).then(e=>(e.setSaveButtonText(r),e.getRoot().on(d.save,async()=>{await i(e)}),e.getRoot().on(d.hidden,()=>{e.destroy()}),e.show(),e)).catch(()=>{})},D=e=>{if(null===e||""==e)return!0;let n=!1;var r=new RegExp(/https?:\/\/(www\.)?[-a-zA-Z0-9@:%._+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()@:%_+.~#?&//=]*)?/gi);return n=e.match(r)?!0:n},I=n=>{var e="name"in(e=n)&&null!==e.name&&void 0!==e.name?"children"in e&&null!==e.children&&void 0!==e.children?Array.isArray(e.children)?0===e.children.length?{error:!0,msg:"'children' Array ist leer."}:{error:!1}:{error:!0,msg:"'children' Eigenschaft ist kein Array."}:{error:!0,msg:"'children' Eigenschaft fehlt."}:{error:!0,msg:"'name' Eigenschaft fehlt."};if(e.error)return e;let r="<pre>";for(let e=0;e<n.children.length;e++){var i=n.children[e],t=(e=>{if(!("name"in e&&null!==e.name&&void 0!==e.name))return{error:!0,msg:"'name' Eigenschaft fehlt bei einem Themenbereich."};if("string"!=typeof e.name)return{error:!0,msg:`'name' Eigenschaft bei dem Themenbereich '${e.name}' ist kein String.`};if("link"in e){if("string"!=typeof e.link)return{error:!0,msg:`'link' Eigenschaft bei dem Themenbereich '${e.name}' ist kein String.`};if(!D(e.link))return{error:!0,msg:`'link' Eigenschaft bei dem Themenbereich '${e.name}' ist ungültig.`}}else{if("keyword"in e&&"string"!=typeof e.keyword)return{error:!0,msg:`'keyword' Eigenschaft bei dem Themenbereich ${e.name} ist kein String.`};if(!("children"in e&&null!==e.children&&void 0!==e.children))return{error:!1};if(!Array.isArray(e.children))return{error:!0,msg:`'children' Eigenschaft bei dem Themenbereich '${e.name}' ist kein Array.`}}return{error:!1}})(i);if(t.error)return t;r+=i.name.replaceAll("&","&amp").replaceAll("<","&lt").replaceAll(">","&gt")+`
`;for(let e=0;e<i.children.length;e++){var o=i.children[e],a=((e,n)=>{if(!("name"in n&&null!==n.name&&void 0!==n.name))return{error:!0,msg:`Ein Lernziel von dem Themenbereich '${e}' hat keine 'name' Eigenschaft.`};if("string"!=typeof n.name)return{error:!0,msg:`'name' Eigenschaft bei einem Lernziel von dem Themenbereich '${e}' ist kein String.`};if("link"in n){if("string"!=typeof n.link)return{error:!0,msg:`'link' Eigenschaft bei dem Lernziel '${n.name}' ist kein String.`};if(!D(n.link))return{error:!0,msg:`'link' Eigenschaft bei dem Lernziel '${n.name}' ist ungültig.`}}else if("keyword"in n&&"string"!=typeof n.keyword)return{error:!0,msg:`'keyword' Eigenschaft bei dem Lernziel '${n.name}' ist kein String.`};return{error:!1}})(i.name,o);if(a.error)return a;a=e==i.children.length-1;r+=` |- ${o.name.replaceAll("&","&amp").replaceAll("<","&lt").replaceAll(">","&gt")}
`+(a?"\n\n":"\n")}}return{error:!1,preview:r+="</pre>"}},N=()=>{var e=document.querySelector("#json-file");if(0!==e.files.length){const r=new FileReader;r.readAsText(e.files[0],"UTF-8"),r.onload=e=>{if(null!==e.target)try{const i=JSON.parse(r.result);var n=I(i);n.error?z("Ungültige Taxonomie","Die hochgeladene Datei ist ungültig:<br/>"+n.msg,"Schließen",e=>{e.hide()}):z("Neue Themenbereiche und Lernziele","Möchten Sie die aktuellen Themenbereiche und Lernziele mit den folgenden ersetzen?\n"+n.preview,"Ersetzen",async e=>{var n;await new Promise((n,r)=>{c.deleteTaxonomy({course:g,coursemodule:m,instance:u}).then(e=>n(e)).catch(e=>r(e))});l("#topics-list").children().remove(),l("#learninggoals-list").children().remove(),n=await new Promise((n,r)=>{c.addTaxonomy({course:g,coursemodule:m,instance:u,taxonomy:JSON.stringify(i)}).then(e=>n(e)).catch(e=>r(e))}),p=JSON.parse(n),f(p),e.hide()})}catch(e){}}}},R=async()=>{var e=await new Promise((n,r)=>{c.getTaxonomy({course:g,coursemodule:m,instance:u}).then(e=>n(JSON.parse(e))).catch(e=>r(e))});let i={name:e.name,children:[]};e.children.forEach(e=>{let n=[];var r={};3<=e.length&&(r.name=e[2],4<=e.length)&&(r.keyword=e[3],5<=e.length)&&(r.link=e[4]),6<=e.length&&e[5].forEach(e=>{n.push({}),3<=e.length&&(n[n.length-1].name=e[2],4<=e.length)&&(n[n.length-1].keyword=e[3],5<=e.length)&&(n[n.length-1].link=e[4])}),r.children=n,i.children.push(r)});var e="taxonomy.json",n=new Blob([JSON.stringify(i,null,2)],{type:"text/csv"}),r=(window.navigator.msSaveOrOpenBlob&&window.navigator.msSaveBlob(n,e),document.createElement("a"));r.setAttribute("href",window.URL.createObjectURL(n)),r.setAttribute("download",e),r.style.display="none",document.body.appendChild(r),r.click(),document.body.removeChild(r)};return{init:(e,n,r,i)=>{g=e,m=n,u=r,p=JSON.parse(i),f(p),l("#newtopic").click(T),l("#newgoal").click(y),l("#json-upload").click(N),l("#json-download").click(R)}}});