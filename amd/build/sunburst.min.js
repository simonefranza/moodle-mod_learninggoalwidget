define(["jquery","mod_learninggoalwidget/controller","mod_learninggoalwidget/selectors","core/config","core/notification","core/templates","core/modal_factory","core/modal_events"],function(g,s,e,i,c,f,y,m){function l(e,t){"Overview"==e?(g(document.querySelector("div[data-region='"+t+"-content-view']")).removeClass("d-none"),g(document.querySelector("div[data-region='"+t+"-exam-view']")).addClass("d-none")):(g(document.querySelector("div[data-region='"+t+"-content-view']")).addClass("d-none"),g(document.querySelector("div[data-region='"+t+"-exam-view']")).removeClass("d-none"))}function u(s,c,u){require(["d3v7"],function(e){e.select("#"+c+"-taxonomy-userprogress-chart").append("p").attr("class","skipLine");var n=e.select("body").append("div").attr("id",c+"-taxonomy-userprogress-chart-fullgoal").style("opacity",0).style("position","absolute").style("vertical-align","center").style("text-align","center").style("width","12vw").style("min-height","4vh").style("font","sans-serif").style("background","lightgrey").style("border","1px solid darkgrey").style("border-radius","10%/20%").style("pointer-events","none"),t=Math.min(360,360)/2,r=e.select("#"+c+"-taxonomy-userprogress-chart").append("svg").attr("class","svgChart").attr("viewBox","0 0 360 360").append("g").attr("transform","translate(180,180)").attr("class","mainG"),t=e.partition().size([2*Math.PI,t]);let a=e.hierarchy(s).eachBefore(e=>{let r=1;if(0<e.depth)for(let n=0;n<e.depth;n++){let t=e;for(let e=0;e<n+1;e++)t=t.parent;r*=t.children.length}e.value=1/r,e.data.size=e.value});t(a);var o=e.arc().startAngle(function(e){return e.x0}).endAngle(function(e){return e.x1}).innerRadius(function(e){return e.y0}).outerRadius(function(e){return e.y1}),i=(r.selectAll("g").data(a.descendants()).enter().append("g").attr("class","node").append("path").attr("class",function(e){return e.data.name}).attr("display",function(e){return e.depth?null:"none"}).style("stroke","#fff").attr("stroke-width","3").style("fill",e=>{e=E(e);return null==e?k(0):0<e.toString().length?k(e):void 0}).style("cursor",e=>{if(!e.children)return"pointer"}).attr("id",(e,t)=>{if(1==e.depth)return"ArcNum"+t}).attr("d",o).on("mouseover",(e,t)=>{n.transition().duration(200).style("opacity",.8),n.html(t.data.name).style("left",e.pageX+"px").style("top",e.pageY-36+"px"),h(c,t,k(E(t)),!0)}).on("mouseout",(e,t)=>{n.transition().duration(500).style("opacity",0),h(c,t,k(E(t)),!1)}).on("click",function(e,n){var r,a,o,i,l,d,s,c,u,p,t,h;n.children||(r=M(this),a=O(this),o=z(this),i=I(this),l=_(this),d=n.data.name,s=n.data.goalid,c=0,u=n.parent.data.topicid,p=(new Date).getTime(),t={progressValue:n.data.pro,modalId:p},(h=v[n.data.name])?h.show():y.create({type:y.types.SAVE_CANCEL,title:"Mein Lernfortschritt f√ºr das Lernziel '"+n.data.name+"':",body:f.render(x.EDIT_PROGRESS_VALUES,t)}).done(function(t){(v[n.data.name]=t).getRoot().on(m.save,function(e){e.preventDefault(),c=document.getElementById("progressvalue-"+p).value,A(i,r,a,o,l,u,s,d,c),t.hide()}),t.getRoot().find("progressvalue-"+p),g(t.getRoot()).on("input","#progressvalue-"+p,function(){P(p)}),t.show()}))}),function(e){var t=0;return e.children&&e.children.forEach(function(e){e=i(e);t<e&&(t=e)}),1+t}),l=18/i(a)-1,d=(r.selectAll(".node").data(a.descendants()).append("text").style("pointer-events","none").text(e=>{var t,n;if(0<e.depth&&e.data.size<=.1)return t=e.data.name.toString(),null!==(n=E(e))&&0<n.toString().length&&(t=0<e.data.keyword.length?n+"% "+e.data.keyword:n+"% "+t),1<e.depth&&(l=28/i(a)-1),t.length>l?t.substring(0,l)+"...":t}).attr("transform",e=>{if(0<e.depth&&e.data.size<=.1)return"translate("+o.centroid(e)+")rotate("+function(e){e=(e.x0+e.x1)/Math.PI*90;return e<=90&&0<=e?e-90:90<e&&e<180?-1*(90-e):180<=e?e-270:0}(e)+")"}).style("font-size",function(e){return 1<e.depth?10:12}).attr("dx","-20").attr("dy",".5em"),90),t=(1<s.children.length&&(d-=2*s.children.length),r.selectAll(".node").data(a.descendants()).append("text").style("pointer-events","none").attr("dy",function(e){return!(1==e.depth&&1==e.parent.children.length||2==e.depth&&1==e.parent.children.length&&1==e.parent.parent.children.length)&&90<(e=(e.x0+e.x1)/Math.PI*90)&&e<270?-25:30}).append("textPath").attr("xlink:href",function(e,t){return"#"+c+"skillArc_"+t}).style("text-anchor","middle").attr("startOffset","50%").style("font-size",function(e){return 1<e.depth?10:12}).attr("letter-spacing",2.75).text(e=>{var t,n;if(0<e.depth&&.1<e.data.size)return t=Math.round(e.data.size*d),n=e.data.name,(n=0<e.data.keyword.length?e.data.keyword:n).length>t?n.substring(0,t-3)+"...":n}),r.selectAll(".node").data(a.descendants()).append("text").style("pointer-events","none").attr("dy",function(e){return 1==e.depth&&1==e.parent.children.length||2==e.depth&&1==e.parent.children.length&&1==e.parent.parent.children.length?40:90<(e=(e.x0+e.x1)/Math.PI*90)&&e<270?-10:50}).append("textPath").attr("xlink:href",function(e,t){return"#"+c+"skillArc_"+t}).style("text-anchor","middle").attr("startOffset","50%").style("font-size",function(e){return 1<e.depth?10:12}).attr("letter-spacing",2.75).text(e=>{if(0<e.depth&&.1<e.data.size){e=E(e);if(null!==e&&0<e.toString().length)return e+"%"}}),e.select("#"+c+"-taxonomy-userprogress-legend").append("svg").attr("class","svgLegend").attr("viewBox","0 0 360 45")),r=(t.append("defs").append("linearGradient").attr("id","legendGradientMulti").attr("x1","0%").attr("y1","0%").attr("x2","100%").attr("y2","0%").selectAll("stop").data([{offset:"0%",color:b(0)},{offset:"12.5%",color:b(.125)},{offset:"25%",color:b(.25)},{offset:"37.5%",color:b(.375)},{offset:"50%",color:b(.5)},{offset:"62.5%",color:b(.625)},{offset:"75%",color:b(.75)},{offset:"87.5%",color:b(.875)},{offset:"100%",color:b(1)}]).enter().append("stop").attr("offset",function(e){return e.offset}).attr("stop-color",function(e){return e.color}),t.append("g").attr("class","legendWrapper").attr("transform","translate(180,20)")),t=(r.append("rect").attr("class","legendRect").attr("x",-90).attr("y",0).attr("rx",4).attr("width",180).attr("height",8).style("fill","url(#legendGradientMulti)"),r.append("text").attr("class","legendTitle").attr("x",0).attr("y",-8).style("text-anchor","middle").text(u),e.scaleLinear().range([-90,90]).domain([0,100])),e=e.axisBottom().ticks(5).tickFormat(function(e){return e+"%"}).scale(t);r.append("g").attr("class","axis").attr("transform","translate(0,8)").call(e)})}var v={},x={EDIT_PROGRESS_VALUES:"mod_learninggoalwidget/widget/sunburst-edit-progress-view"},p=function(e,t,d){var s=document.createElement("ul");s.style="list-style: none",t.forEach(function(e){if("topic"==e.type){var t=d,n=g("#"+d+"-listing-view"),r=e,a=document.createElement("p"),t=(a.setAttribute("id",t+"-topic-"+r.topicid),document.createElement("span")),o="";if(r.keyword!="")o=r.keyword+" - "+r.name;else o=r.name;if(r.link){var i=document.createElement("a");i.setAttribute("href",r.link);i.setAttribute("target","_blank");i.textContent=o;t.appendChild(i)}else t.textContent=o;a.appendChild(t),n.append(a)}if("goal"==e.type){r=d,i=s,o=e,t=document.createElement("li"),n=(t.setAttribute("id",r+"-goal-"+o.goalid),document.createElement("span")),a=(n.className="bulletPoint",t.appendChild(n),"");if(o.keyword!="")a=o.keyword+" - "+o.name;else a=o.name;if(o.link){var l=document.createElement("a");l.setAttribute("href",o.link);l.setAttribute("target","_blank");l.textContent=a;t.appendChild(l)}else{l=document.createElement("span");l.textContent=a;t.appendChild(l)}i.append(t)}e.children&&p(g("#"+d+"-listing-view"),e.children,d)}),g("#"+d+"-listing-view").append(s)},h=function(t,n,r,a){let o;if("goal"===n.data.type&&(o=g("#"+t+"-goal-"+n.data.goalid)),o="topic"===n.data.type?g("#"+t+"-topic-"+n.data.topicid):o){let e;if(a){o.addClass("taxItemHighlighted"),(e=o[0].querySelector(".bulletPoint"))&&r&&(e.style.background=r),n.children&&d(t,n.children,!0);{var i=t,l=n;let e;if("data"in l&&"type"in l.data){switch(l.data.type){case"goal":e=document.getElementById(i+"-goal-"+l.data.goalid);break;case"topic":e=document.getElementById(i+"-topic-"+l.data.topicid);break;default:throw new Error("Unknown type: "+l.data.type)}e.scrollIntoView({behavior:"smooth",block:"nearest"})}}}else o.removeClass("taxItemHighlighted"),(e=o[0].querySelector(".bulletPoint"))&&(e.style.background="black"),n.children&&d(t,n.children,!1)}},d=function(a,e,o){e.forEach(e=>{let t;"goal"===e.data.type&&(t=g("#"+a+"-goal-"+e.data.goalid));let n;var r;(t="topic"===e.data.type?g("#"+a+"-topic-"+e.data.topicid):t)&&(o?(t.addClass("taxItemHighlighted"),n=t[0].querySelector(".bulletPoint"),r=k(E(e)),n&&r&&(n.style.background=r)):(t.removeClass("taxItemHighlighted"),(n=t[0].querySelector(".bulletPoint"))&&(n.style.background="black"))),e.children&&d(a,e.children,o)})},w=[{pct:0,color:{r:204,g:0,b:0}},{pct:.5,color:{r:255,g:255,b:0}},{pct:1,color:{r:0,g:102,b:0}}],b=function(e){let t;for(t=1;t<w.length-1&&!(e<w[t].pct);t++);var n=w[t-1],r=w[t],a=r.pct-n.pct,a=(e-n.pct)/a,o=1-a;return"#"+((1<<24)+(Math.floor(n.color.r*o+r.color.r*a)<<16)+(Math.floor(n.color.g*o+r.color.g*a)<<8)+Math.floor(n.color.b*o+r.color.b*a)).toString(16).slice(1)},k=function(e){switch(!0){case e<=0:return"#e5e5e5";case e<=12.5:return b(.125);case e<=25:return b(.25);case e<=37.5:return b(.375);case e<=50:case e<=62.5:return b(.5);case e<=75:return b(.75);case e<=87.5:case e<=100:return b(.875);default:throw new Error("Cant get the coloring, the progress value is over 100% !")}},E=function(e){if(e.children){for(var t=0,n=0;n<e.children.length;n++)t+=E(e.children[n]);return void 0===(t=Math.round(t/e.children.length))||isNaN(t)?"":t}return e.data.pro},A=function(t,e,n,r,a,o,i,l,d){s.updateUserProgress({courseid:e,coursemoduleid:n,instanceid:r,userid:a,topicid:o,goalid:i,progress:d}).then(e=>{var e=JSON.parse(e);0<e.children.length&&(g("div#"+t+"-taxonomy-userprogress-chart-fullgoal").remove(),g("#"+t+"-taxonomy-userprogress-chart").empty(),g("#"+t+"-taxonomy-userprogress-legend").empty(),u(e,t),e=new CustomEvent("update_learning_goal_progress",{bubbles:!0,detail:{sender:"sunburst",taxonomy:e,sunburstId:t}}),g("#"+t+"-taxonomy")[0].dispatchEvent(e))}).catch(c.exception);o=C("preparationSaveProgress",e,n,r,a),i=new Object,i.name="goalname",i.value=l,l=new Object;l.name="goalprogress",l.value=d,o.push(i),o.push(l),S(e,n,r,a,o)},S=function(e,t,n,r,a){s.logEvent({courseid:e,coursemoduleid:t,instanceid:n,userid:r,eventparams:a}).then(()=>{}).catch(c.exception)},C=function(e,t,n,r){var a=new Object,e=(a.name="courseid",a.value=e,new Object),t=(e.name="coursemoduleid",e.value=t,new Object),n=(t.name="instanceid",t.value=n,new Object),r=(n.name="userid",n.value=r,new Object);return r.name="timestamp",r.value=Math.trunc((new Date).getTime()/1e3),[a,e,t,n,r]},P=function(e){var t=document.getElementById("progressvalue-"+e),e=document.getElementById("progressvaluelabel-"+e);t&&e&&(e.innerHTML=t.value+"%")},I=function(e){e=g(e).closest("div.telm-learninggoals-widget");return g(e).data("sunburst-id")},M=function(e){e=g(e).closest("div.telm-learninggoals-widget");return g(e).data("course-id")},O=function(e){e=g(e).closest("div.telm-learninggoals-widget");return g(e).data("coursemodule-id")},z=function(e){e=g(e).closest("div.telm-learninggoals-widget");return g(e).data("instance-id")},_=function(e){e=g(e).closest("div.telm-learninggoals-widget");return g(e).data("user-id")};return{renderSunburst:function(r,e,t,n,a,o){require.config({paths:{d3v7:i.wwwroot+"/mod/learninggoalwidget/js/d3.v7.min"}}),s.getLearningGoals({courseid:t,userid:e,coursemoduleid:n,instanceid:a}).then(e=>{var t,n,s,c,e=JSON.parse(e);return 0<e.children.length&&(s=e,c=r,require(["d3v7"],function(n){n.select("#"+c+"-taxonomy").append("p").attr("class","skipLine");var r=n.select("body").append("div").attr("id",c+"-taxonomy-fullgoal").style("opacity",0).style("position","absolute").style("vertical-align","center").style("text-align","center").style("width","12vw").style("min-height","4vh").style("font","sans-serif").style("background","lightgrey").style("border","1px solid darkgrey").style("border-radius","10%/20%").style("pointer-events","none"),e=Math.min(360,360)/2,t=n.select("#"+c+"-taxonomy").append("svg").attr("class","svgChart").attr("viewBox","0 0 360 360").append("g").attr("transform","translate(180,180)").attr("class","mainG"),e=(n.select("#"+c+"-text-path-storage").append("svg").attr("id",c+"-PathBlock").attr("height","0%").attr("width","0%").style("display","none"),n.partition().size([2*Math.PI,e])),a=n.hierarchy(s).eachBefore(e=>{let r=1;if(0<e.depth)for(let n=0;n<e.depth;n++){let t=e;for(let e=0;e<n+1;e++)t=t.parent;r*=t.children.length}e.value=1/r,e.data.size=e.value}),o=(e(a),n.arc().startAngle(function(e){return e.x0}).endAngle(function(e){return e.x1}).innerRadius(function(e){return e.y0}).outerRadius(function(e){return e.y1}));t.selectAll("g").data(a.descendants()).enter().append("g").attr("class","node").append("path").attr("class",function(e){return e.data.name}).attr("display",function(e){return e.depth?null:"none"}).style("stroke","#fff").attr("stroke-width","3").style("fill","#e5e5e5").style("cursor",function(e){return e.data.link?"pointer":"default"}).attr("d",o).on("mouseover",function(e,t){r.transition().duration(200).style("opacity",.8),r.html(t.data.name).style("left",e.pageX+"px").style("top",e.pageY-36+"px"),h(c,t,k(E(t)),!0)}).on("mouseout",function(e,t){r.transition().duration(500).style("opacity",0),h(c,t,k(E(t)),!1)}).on("click",function(e,t){var n,r,a,o,i,l;1<=t.depth&&(t.data.link&&(window.open(t.data.link),n=M(this),r=O(this),a=z(this),o=_(this),i=C("overviewOpenLink",n,r,a,o),(l=new Object).name="url",l.value=t.data.link,i.push(l),S(n,r,a,o,i)),l=new CustomEvent("sunburstclick",{bubbles:!0,detail:{data:()=>t.data}}),g("#"+c+"-taxonomy")[0].dispatchEvent(l))}).each(function(e,t){0<e.depth&&(e=function(e,t){let n;var r;return 1==e.depth&&1==e.parent.children.length||2==e.depth&&1==e.parent.children.length&&1==e.parent.parent.children.length?(n=t.replace(/,/g," "),n=/^([^A]*A[^A]*)/.exec(n)[1]):(n=(n=/(^.+?)L/.exec(t)[1]).replace(/,/g," "),90<(t=(e.x0+e.x1)/Math.PI*90)&&t<270?(e=/0 0 1 (.*?)$/.exec(n)[1],t=/M(.*?)A/.exec(n)[1],r=/A(.*?)0 0 1/.exec(n)[1],n="M"+e+"A"+r+"0 0 0 "+t):n)}(e,n.select(this).attr("d")),n.select("#"+c+"-PathBlock").append("path").attr("id",c+"skillArc_"+t).attr("d",e).style("fill","none"))});var i=e=>{var t=0;return e.children&&e.children.forEach(e=>{e=i(e);t<e&&(t=e)}),1+t},l=18/i(a)-1,d=(t.selectAll(".node").data(a.descendants()).append("text").text(e=>{var t;if(0<e.depth&&e.data.size<=.1)return t=e.data.name.toString(),(t=0<e.data.keyword.length?e.data.keyword:t).length>l?t.substring(0,l)+"...":t}).attr("transform",e=>{if(0<e.depth&&e.data.size<=.1)return"translate("+o.centroid(e)+")rotate("+function(e){e=(e.x0+e.x1)/Math.PI*90;return e<=90&&0<=e?e-90:90<e&&e<180?-1*(90-e):180<=e?e-270:0}(e)+")"}).style("font-size",12).style("pointer-events","none").attr("dx","-20").attr("dy",".5em"),90);1<s.children.length&&(d-=2*s.children.length),t.selectAll(".node").data(a.descendants()).append("text").attr("dy",function(e){return!(1==e.depth&&1==e.parent.children.length||2==e.depth&&1==e.parent.children.length&&1==e.parent.parent.children.length)&&90<(e=(e.x0+e.x1)/Math.PI*90)&&e<270?-25:30}).append("textPath").attr("xlink:href",function(e,t){return"#"+c+"skillArc_"+t}).style("text-anchor","middle").attr("startOffset","50%").style("font-size",12).style("pointer-events","none").attr("letter-spacing",2.75).text(e=>{var t,n;if(0<e.depth&&.1<e.data.size)return t=Math.round(e.data.size*d),n=e.data.name,(n=0<e.data.keyword.length?e.data.keyword:n).length>t?n.substring(0,t-3)+"...":n})}),u(e,r,o),e=e,t=r,(n=document.getElementById(t+"-listing-view")).style.position="relative",p(n,e.children,t)),0}).catch(function(){}),document.getElementById(r+"-ClickedOverview").onclick=function(){var e=I(this),t=M(this),n=O(this),r=z(this),a=_(this),e=(l("Overview",e),C("clickedOverview",t,n,r,a));S(t,n,r,a,e)},document.getElementById(r+"-ClickedPreparation").onclick=function(){var e=I(this),t=M(this),n=O(this),r=z(this),a=_(this),e=(l("Preparation",e),C("clickedPreparation",t,n,r,a));S(t,n,r,a,e)},document.querySelector("div[data-region='"+r+"-content-view']").style.width="33%",document.querySelector("div[data-region='"+r+"-content-view']").style.height="33%",document.querySelector("div[data-region='"+r+"-exam-view']").style.width="33%",document.querySelector("div[data-region='"+r+"-exam-view']").style.height="33%%",g(document.querySelector("div[data-region='"+r+"-content-view']")).removeClass("d-none"),g(document.querySelector("div[data-region='"+r+"-exam-view']")).addClass("d-none")},renderSunburstWithProgressView:u,UpdateLearningProgress:P}});
//# sourceMappingURL=sunburst.min.js.map