define(["jquery","mod_learninggoalwidget/controller","mod_learninggoalwidget/selectors","core/config","core/notification","core/templates","core/modal_factory","core/modal_events"],function(h,s,t,o,c,g,f,m){function l(t,e){"Overview"==t?(h(document.querySelector("div[data-region='"+e+"-content-view']")).removeClass("d-none"),h(document.querySelector("div[data-region='"+e+"-exam-view']")).addClass("d-none")):(h(document.querySelector("div[data-region='"+e+"-content-view']")).addClass("d-none"),h(document.querySelector("div[data-region='"+e+"-exam-view']")).removeClass("d-none"))}function u(s,c,u){require(["d3v4"],function(e){e.select("#"+c+"-taxonomy-userprogress-chart").append("p").attr("class","skipLine");var n=e.select("body").append("div").attr("id",c+"-taxonomy-userprogress-chart-fullgoal").style("opacity",0).style("position","absolute").style("vertical-align","center").style("text-align","center").style("width","12vw").style("min-height","4vh").style("font","sans-serif").style("background","lightgrey").style("border","1px solid darkgrey").style("border-radius","10%/20%").style("pointer-events","none"),t=Math.min(360,360)/2,a=e.select("#"+c+"-taxonomy-userprogress-chart").append("svg").attr("class","svgChart").attr("viewBox","0 0 360 360").append("g").attr("transform","translate(180,180)").attr("class","mainG"),t=e.partition().size([2*Math.PI,t]);let r=e.hierarchy(s).eachBefore(t=>{let a=1;if(0<t.depth)for(let n=0;n<t.depth;n++){let e=t;for(let t=0;t<n+1;t++)e=e.parent;a*=e.children.length}t.value=1/a,t.data.size=t.value});t(r);var i=e.arc().startAngle(function(t){return t.x0}).endAngle(function(t){return t.x1}).innerRadius(function(t){return t.y0}).outerRadius(function(t){return t.y1}),o=(a.selectAll("g").data(r.descendants()).enter().append("g").attr("class","node").append("path").attr("class",function(t){return t.data.name}).attr("display",function(t){return t.depth?null:"none"}).style("stroke","#fff").attr("stroke-width","3").style("fill",t=>{t=E(t);return null==t?A(0):0<t.toString().length?A(t):void 0}).style("cursor",t=>{if(!t.children)return"pointer"}).attr("id",(t,e)=>{if(1==t.depth)return"ArcNum"+e}).attr("d",i).on("mouseover",t=>{n.transition().duration(200).style("opacity",.8),n.html(t.data.name).style("left",e.event.pageX+"px").style("top",e.event.pageY-36+"px"),x(c,t,A(E(t)),!0)}).on("mouseout",t=>{n.transition().duration(500).style("opacity",0),x(c,t,A(E(t)),!1)}).on("click",function(t){var n,a,r,i,o,l,d,s,c,u,e,p;t.children||(n=O(this),a=z(this),r=_(this),i=I(this),o=q(this),l=t.data.name,d=t.data.goalid,s=0,c=t.parent.data.topicid,u=(new Date).getTime(),e={progressValue:t.data.pro,modalId:u},(p=y[t.data.name])?p.show():f.create({type:f.types.SAVE_CANCEL,title:"Mein Lernfortschritt f√ºr das Lernziel '"+t.data.name+"':",body:g.render(v.EDIT_PROGRESS_VALUES,e)}).done(function(e){(y[t.data.name]=e).getRoot().on(m.save,function(t){t.preventDefault(),s=document.getElementById("progressvalue-"+u).value,S(i,n,a,r,o,c,d,l,s),e.hide()}),e.getRoot().find("progressvalue-"+u),h(e.getRoot()).on("input","#progressvalue-"+u,function(){M(u)}),e.show()}))}),function(t){var e=0;return t.children&&t.children.forEach(function(t){t=o(t);e<t&&(e=t)}),1+e}),l=18/o(r)-1,d=(a.selectAll(".node").data(r.descendants()).append("text").text(t=>{var e,n;if(0<t.depth&&t.data.size<=.1)return e=t.data.name.toString(),null!==(n=E(t))&&0<n.toString().length&&(e=0<t.data.keyword.length?n+"% "+t.data.keyword:n+"% "+e),1<t.depth&&(l=28/o(r)-1),e.length>l?e.substring(0,l)+"...":e}).attr("transform",t=>{if(0<t.depth&&t.data.size<=.1)return"translate("+i.centroid(t)+")rotate("+function(t){t=(t.x0+t.x1)/Math.PI*90;return t<=90&&0<=t?t-90:90<t&&t<180?-1*(90-t):180<=t?t-270:0}(t)+")"}).style("font-size",function(t){return 1<t.depth?10:12}).attr("dx","-20").attr("dy",".5em"),90),t=(1<s.children.length&&(d-=2*s.children.length),a.selectAll(".node").data(r.descendants()).append("text").attr("dy",function(t){return!(1==t.depth&&1==t.parent.children.length||2==t.depth&&1==t.parent.children.length&&1==t.parent.parent.children.length)&&90<(t=(t.x0+t.x1)/Math.PI*90)&&t<270?-25:30}).append("textPath").attr("xlink:href",function(t,e){return"#"+c+"skillArc_"+e}).style("text-anchor","middle").attr("startOffset","50%").style("font-size",function(t){return 1<t.depth?10:12}).attr("letter-spacing",2.75).text(t=>{var e,n;if(0<t.depth&&.1<t.data.size)return e=Math.round(t.data.size*d),n=t.data.name,(n=0<t.data.keyword.length?t.data.keyword:n).length>e?n.substring(0,e-3)+"...":n}),a.selectAll(".node").data(r.descendants()).append("text").attr("dy",function(t){return 1==t.depth&&1==t.parent.children.length||2==t.depth&&1==t.parent.children.length&&1==t.parent.parent.children.length?40:90<(t=(t.x0+t.x1)/Math.PI*90)&&t<270?-10:50}).append("textPath").attr("xlink:href",function(t,e){return"#"+c+"skillArc_"+e}).style("text-anchor","middle").attr("startOffset","50%").style("font-size",function(t){return 1<t.depth?10:12}).attr("letter-spacing",2.75).text(t=>{if(0<t.depth&&.1<t.data.size){t=E(t);if(null!==t&&0<t.toString().length)return t+"%"}}),e.select("#"+c+"-taxonomy-userprogress-legend").append("svg").attr("class","svgLegend").attr("viewBox","0 0 360 45")),a=(t.append("defs").append("linearGradient").attr("id","legendGradientMulti").attr("x1","0%").attr("y1","0%").attr("x2","100%").attr("y2","0%").selectAll("stop").data([{offset:"0%",color:k(0)},{offset:"12.5%",color:k(.125)},{offset:"25%",color:k(.25)},{offset:"37.5%",color:k(.375)},{offset:"50%",color:k(.5)},{offset:"62.5%",color:k(.625)},{offset:"75%",color:k(.75)},{offset:"87.5%",color:k(.875)},{offset:"100%",color:k(1)}]).enter().append("stop").attr("offset",function(t){return t.offset}).attr("stop-color",function(t){return t.color}),t.append("g").attr("class","legendWrapper").attr("transform","translate(180,20)")),t=(a.append("rect").attr("class","legendRect").attr("x",-90).attr("y",0).attr("rx",4).attr("width",180).attr("height",8).style("fill","url(#legendGradientMulti)"),a.append("text").attr("class","legendTitle").attr("x",0).attr("y",-8).style("text-anchor","middle").text(u),e.scaleLinear().range([-90,90]).domain([0,100])),t=e.axisBottom().ticks(5).tickFormat(function(t){return t+"%"}).scale(t);a.append("g").attr("class","axis").attr("transform","translate(0,8)").call(t)})}var y={},v={EDIT_PROGRESS_VALUES:"mod_learninggoalwidget/widget/sunburst-edit-progress-view"},p=function(t,e,d){var s=document.createElement("ul");s.style="list-style: none",e.forEach(function(t){if("topic"==t.type){var e=d,n=h("#"+d+"-listing-view"),a=t,r=document.createElement("p"),e=(r.setAttribute("id",e+"-topic-"+a.topicid),document.createElement("span")),i="";if(a.keyword!="")i=a.keyword+" - "+a.name;else i=a.name;if(a.link){var o=document.createElement("a");o.setAttribute("href",a.link);o.setAttribute("target","_blank");o.textContent=i;e.appendChild(o)}else e.textContent=i;r.appendChild(e),n.append(r)}if("goal"==t.type){a=d,o=s,i=t,e=document.createElement("li"),n=(e.setAttribute("id",a+"-goal-"+i.goalid),document.createElement("span")),r=(n.className="bulletPoint",e.appendChild(n),"");if(i.keyword!="")r=i.keyword+" - "+i.name;else r=i.name;if(i.link){var l=document.createElement("a");l.setAttribute("href",i.link);l.setAttribute("target","_blank");l.textContent=r;e.appendChild(l)}else{l=document.createElement("span");l.textContent=r;e.appendChild(l)}o.append(e)}t.children&&p(h("#"+d+"-listing-view"),t.children,d)}),h("#"+d+"-listing-view").append(s)},x=function(e,n,a,r){let i;if("goal"===n.data.type&&(i=h("#"+e+"-goal-"+n.data.goalid)),i="topic"===n.data.type?h("#"+e+"-topic-"+n.data.topicid):i){let t;r?(i.addClass("taxItemHighlighted"),(t=i[0].querySelector(".bulletPoint"))&&a&&(t.style.background=a),n.children&&w(e,n.children,!0),d(e,n)):(i.removeClass("taxItemHighlighted"),(t=i[0].querySelector(".bulletPoint"))&&(t.style.background="black"),n.children&&w(e,n.children,!1))}},d=function(t,e){let n;e.parent&&null===e.parent.parent?("goal"===e.data.type&&(n=h("#"+t+"-goal-"+e.data.goalid)),(n="topic"===e.data.type?h("#"+t+"-topic-"+e.data.topicid):n)&&h("#"+t+"-listing-view-container").animate({scrollTop:n[0].offsetTop-8,duration:"fast"})):d(t,e.parent)},w=function(r,t,i){t.forEach(t=>{let e;"goal"===t.data.type&&(e=h("#"+r+"-goal-"+t.data.goalid));let n;var a;(e="topic"===t.data.type?h("#"+r+"-topic-"+t.data.topicid):e)&&(i?(e.addClass("taxItemHighlighted"),n=e[0].querySelector(".bulletPoint"),a=A(E(t)),n&&a&&(n.style.background=a)):(e.removeClass("taxItemHighlighted"),(n=e[0].querySelector(".bulletPoint"))&&(n.style.background="black"))),t.children&&w(r,t.children,i)})},b=[{pct:0,color:{r:204,g:0,b:0}},{pct:.5,color:{r:255,g:255,b:0}},{pct:1,color:{r:0,g:102,b:0}}],k=function(t){let e;for(e=1;e<b.length-1&&!(t<b[e].pct);e++);var n=b[e-1],a=b[e],r=a.pct-n.pct,r=(t-n.pct)/r,i=1-r;return"#"+((1<<24)+(Math.floor(n.color.r*i+a.color.r*r)<<16)+(Math.floor(n.color.g*i+a.color.g*r)<<8)+Math.floor(n.color.b*i+a.color.b*r)).toString(16).slice(1)},A=function(t){switch(!0){case t<=0:return"#e5e5e5";case t<=12.5:return k(.125);case t<=25:return k(.25);case t<=37.5:return k(.375);case t<=50:case t<=62.5:return k(.5);case t<=75:return k(.75);case t<=87.5:case t<=100:return k(.875);default:throw new Error("Cant get the coloring, the progress value is over 100% !")}},E=function(t){if(t.children){for(var e=0,n=0;n<t.children.length;n++)e+=E(t.children[n]);return void 0===(e=Math.round(e/t.children.length))||isNaN(e)?"":e}return t.data.pro},S=function(e,t,n,a,r,i,o,l,d){s.updateUserProgress({courseid:t,coursemoduleid:n,instanceid:a,userid:r,topicid:i,goalid:o,progress:d}).then(t=>{var t=JSON.parse(t);0<t.children.length&&(h("div#"+e+"-taxonomy-userprogress-chart-fullgoal").remove(),h("#"+e+"-taxonomy-userprogress-chart").empty(),h("#"+e+"-taxonomy-userprogress-legend").empty(),u(t,e),t=new CustomEvent("update_learning_goal_progress",{bubbles:!0,detail:{sender:"sunburst",taxonomy:t,sunburstId:e}}),h("#"+e+"-taxonomy")[0].dispatchEvent(t))}).catch(c.exception);i=P("preparationSaveProgress",t,n,a,r),o=new Object,o.name="goalname",o.value=l,l=new Object;l.name="goalprogress",l.value=d,i.push(o),i.push(l),C(t,n,a,r,i)},C=function(t,e,n,a,r){s.logEvent({courseid:t,coursemoduleid:e,instanceid:n,userid:a,eventparams:r}).then(()=>{}).catch(c.exception)},P=function(t,e,n,a){var r=new Object,i=new Object,t=(i.name="courseid",i.value=t,new Object),e=(t.name="coursemoduleid",t.value=e,new Object),n=(e.name="instanceid",e.value=n,new Object),a=(n.name="userid",n.value=a,new Object);return a.name="timestamp",a.value=Math.trunc((new Date).getTime()/1e3),[r,i,t,e,n,a]},M=function(t){var e=document.getElementById("progressvalue-"+t),t=document.getElementById("progressvaluelabel-"+t);e&&t&&(t.innerHTML=e.value+"%")},I=function(t){t=h(t).closest("div.telm-learninggoals-widget");return h(t).data("sunburst-id")},O=function(t){t=h(t).closest("div.telm-learninggoals-widget");return h(t).data("course-id")},z=function(t){t=h(t).closest("div.telm-learninggoals-widget");return h(t).data("coursemodule-id")},_=function(t){t=h(t).closest("div.telm-learninggoals-widget");return h(t).data("instance-id")},q=function(t){t=h(t).closest("div.telm-learninggoals-widget");return h(t).data("user-id")};return{renderSunburst:function(a,t,e,n,r,i){require.config({paths:{d3v4:o.wwwroot+"/mod/learninggoalwidget/js/d3.v4.min"}}),s.getLearningGoals({courseid:e,userid:t,coursemoduleid:n,instanceid:r}).then(t=>{var e,n,s,c,t=JSON.parse(t);return 0<t.children.length&&(s=t,c=a,require(["d3v4"],function(n){n.select("#"+c+"-taxonomy").append("p").attr("class","skipLine");var e=n.select("body").append("div").attr("id",c+"-taxonomy-fullgoal").style("opacity",0).style("position","absolute").style("vertical-align","center").style("text-align","center").style("width","12vw").style("min-height","4vh").style("font","sans-serif").style("background","lightgrey").style("border","1px solid darkgrey").style("border-radius","10%/20%").style("pointer-events","none"),t=Math.min(360,360)/2,a=n.select("#"+c+"-taxonomy").append("svg").attr("class","svgChart").attr("viewBox","0 0 360 360").append("g").attr("transform","translate(180,180)").attr("class","mainG"),t=(n.select("#"+c+"-text-path-storage").append("svg").attr("id",c+"-PathBlock").attr("height","0%").attr("width","0%").style("display","none"),n.partition().size([2*Math.PI,t])),r=n.hierarchy(s).eachBefore(t=>{let a=1;if(0<t.depth)for(let n=0;n<t.depth;n++){let e=t;for(let t=0;t<n+1;t++)e=e.parent;a*=e.children.length}t.value=1/a,t.data.size=t.value}),i=(t(r),n.arc().startAngle(function(t){return t.x0}).endAngle(function(t){return t.x1}).innerRadius(function(t){return t.y0}).outerRadius(function(t){return t.y1}));a.selectAll("g").data(r.descendants()).enter().append("g").attr("class","node").append("path").attr("class",function(t){return t.data.name}).attr("display",function(t){return t.depth?null:"none"}).style("stroke","#fff").attr("stroke-width","3").style("fill","#e5e5e5").style("cursor",function(t){return t.data.link?"pointer":"default"}).attr("d",i).on("mouseover",function(t){e.transition().duration(200).style("opacity",.8),e.html(t.data.name).style("left",n.event.pageX+"px").style("top",n.event.pageY-36+"px"),x(c,t,A(E(t)),!0)}).on("mouseout",function(t){e.transition().duration(500).style("opacity",0),x(c,t,A(E(t)),!1)}).on("click",function(t){var e,n,a,r,i,o;1<=t.depth&&(t.data.link&&(window.open(t.data.link),e=O(this),n=z(this),a=_(this),r=q(this),i=P("overviewOpenLink",e,n,a,r),(o=new Object).name="url",o.value=t.data.link,i.push(o),C(e,n,a,r,i)),o=new CustomEvent("sunburstclick",{bubbles:!0,detail:{data:()=>t.data}}),h("#"+c+"-taxonomy")[0].dispatchEvent(o))}).each(function(t,e){0<t.depth&&(t=function(t,e){let n;var a;return 1==t.depth&&1==t.parent.children.length||2==t.depth&&1==t.parent.children.length&&1==t.parent.parent.children.length?(n=e.replace(/,/g," "),n=/^([^A]*A[^A]*)/.exec(n)[1]):(n=(n=/(^.+?)L/.exec(e)[1]).replace(/,/g," "),90<(e=(t.x0+t.x1)/Math.PI*90)&&e<270?(t=/0 0 1 (.*?)$/.exec(n)[1],e=/M(.*?)A/.exec(n)[1],a=/A(.*?)0 0 1/.exec(n)[1],n="M"+t+"A"+a+"0 0 0 "+e):n)}(t,n.select(this).attr("d")),n.select("#"+c+"-PathBlock").append("path").attr("id",c+"skillArc_"+e).attr("d",t).style("fill","none"))});var o=t=>{var e=0;return t.children&&t.children.forEach(t=>{t=o(t);e<t&&(e=t)}),1+e},l=18/o(r)-1,d=(a.selectAll(".node").data(r.descendants()).append("text").text(t=>{var e;if(0<t.depth&&t.data.size<=.1)return e=t.data.name.toString(),(e=0<t.data.keyword.length?t.data.keyword:e).length>l?e.substring(0,l)+"...":e}).attr("transform",t=>{if(0<t.depth&&t.data.size<=.1)return"translate("+i.centroid(t)+")rotate("+function(t){t=(t.x0+t.x1)/Math.PI*90;return t<=90&&0<=t?t-90:90<t&&t<180?-1*(90-t):180<=t?t-270:0}(t)+")"}).style("font-size",12).attr("dx","-20").attr("dy",".5em"),90);1<s.children.length&&(d-=2*s.children.length),a.selectAll(".node").data(r.descendants()).append("text").attr("dy",function(t){return!(1==t.depth&&1==t.parent.children.length||2==t.depth&&1==t.parent.children.length&&1==t.parent.parent.children.length)&&90<(t=(t.x0+t.x1)/Math.PI*90)&&t<270?-25:30}).append("textPath").attr("xlink:href",function(t,e){return"#"+c+"skillArc_"+e}).style("text-anchor","middle").attr("startOffset","50%").style("font-size",12).attr("letter-spacing",2.75).text(t=>{var e,n;if(0<t.depth&&.1<t.data.size)return e=Math.round(t.data.size*d),n=t.data.name,(n=0<t.data.keyword.length?t.data.keyword:n).length>e?n.substring(0,e-3)+"...":n})}),u(t,a,i),t=t,e=a,n=document.getElementById(e+"-listing-view"),p(n,t.children,e)),0}).catch(function(){}),document.getElementById(a+"-ClickedOverview").onclick=function(){var t=I(this),e=O(this),n=z(this),a=_(this),r=q(this),t=(l("Overview",t),P("clickedOverview",e,n,a,r));C(e,n,a,r,t)},document.getElementById(a+"-ClickedPreparation").onclick=function(){var t=I(this),e=O(this),n=z(this),a=_(this),r=q(this),t=(l("Preparation",t),P("clickedPreparation",e,n,a,r));C(e,n,a,r,t)},document.querySelector("div[data-region='"+a+"-content-view']").style.width="33%",document.querySelector("div[data-region='"+a+"-content-view']").style.height="33%",document.querySelector("div[data-region='"+a+"-exam-view']").style.width="33%",document.querySelector("div[data-region='"+a+"-exam-view']").style.height="33%%",h(document.querySelector("div[data-region='"+a+"-content-view']")).removeClass("d-none"),h(document.querySelector("div[data-region='"+a+"-exam-view']")).addClass("d-none")},renderSunburstWithProgressView:u,UpdateLearningProgress:M}});